<div class="page-content">
  <div class="header-bar">
    <h1>Welcome to the Drawing App</h1>
    <div class="user-controls">
      <span id="user-info">Sie sind eingeloggt</span>
      <button id="logout-btn" class="logout-button">Ausloggen</button>
    </div>
  </div>
  
  <p>Willkommen in Ihrer Zeichen-Anwendung! Hier können Sie verschiedene Zeichenwerkzeuge verwenden und Ihre Kunstwerke erstellen.</p>
  
  <!-- A 5.4: Canvas-Liste mit Berechtigungsanzeige -->
  <div class="canvas-management">
    <h2>Meine Zeichenflächen (A 5.4: Rechtesystem)</h2>
    <div id="canvas-controls">
      <button id="create-canvas-btn" class="action-button create-button">Neue Zeichenfläche erstellen</button>
      <button id="refresh-canvas-btn" class="action-button refresh-button">Liste aktualisieren</button>
    </div>
    
    <div id="canvas-list" class="canvas-grid">
      <!-- Canvas werden hier dynamisch geladen -->
      <div class="loading">Lade Zeichenflächen...</div>
    </div>
    
    <!-- Create Canvas Modal -->
    <div id="create-canvas-modal" class="modal" style="display:none;">
      <div class="modal-content">
        <h3>Neue Zeichenfläche erstellen</h3>
        <input type="text" id="new-canvas-name" placeholder="Name der Zeichenfläche" maxlength="100">
        <div class="modal-buttons">
          <button id="confirm-create-canvas" class="action-button create-button">Erstellen</button>
          <button id="cancel-create-canvas" class="action-button cancel-button">Abbrechen</button>
        </div>
      </div>
    </div>
    
    <!-- Permission Management Modal -->
    <div id="permission-modal" class="modal" style="display:none;">
      <div class="modal-content permission-modal-content">
        <h3>Manage Permissions</h3>
        <div id="permission-modal-canvas-info" class="canvas-info">
          <!-- Canvas info will be populated here -->
        </div>
        
        <div class="permission-section">
          <h4>Neue Berechtigung hinzufügen</h4>
          <div class="user-search-section">
            <input type="text" id="user-search-input" placeholder="Benutzer suchen (Email oder Name)..." autocomplete="off">
            <div id="user-list-container" class="user-list-container">
              <div id="user-list" class="user-list">
                <div class="loading">Lade Benutzer...</div>
              </div>
            </div>
          </div>
          
          <div id="permission-grant-section" class="permission-grant-section" style="display:none;">
            <div class="selected-user">
              <strong>Ausgewählter Benutzer:</strong> <span id="selected-user-display"></span>
            </div>
            <div class="permission-selector">
              <label>Berechtigung:</label>
              <select id="permission-select" class="enhanced-permission-select">
                <option value="R">Read-Only - Nur Anzeigen</option>
                <option value="W">Write - Zeichnen erlaubt</option>
                <option value="V">Voice - Auch in moderierten Canvas</option>
                <option value="M">Moderator - Moderation + Rechte vergeben</option>
                <option value="O">Owner - Vollzugriff</option>
              </select>
              <div class="permission-explanation">
                <span id="permission-explanation-text">Wählen Sie eine Berechtigung aus</span>
              </div>
            </div>
            <div class="permission-actions">
              <button id="grant-permission-btn" class="action-button create-button">Grant Permission</button>
              <button id="cancel-grant-btn" class="action-button cancel-button">Abbrechen</button>
            </div>
          </div>
        </div>
        
        <div class="permission-section">
          <h4>Bestehende Berechtigungen</h4>
          <div id="existing-permissions" class="permissions-list">
            <!-- Existing permissions will be populated here -->
          </div>
        </div>
        
        <div class="modal-buttons">
          <button id="close-permission-modal" class="action-button cancel-button">Close</button>
        </div>
      </div>
    </div>

    <!-- Edit Permission Modal -->
    <div id="edit-permission-modal" class="modal" style="display:none;">
      <div class="modal-content edit-permission-modal-content">
        <h3>Berechtigung ändern</h3>
        <div id="edit-permission-user-info" class="user-info-display">
          <!-- User info will be populated here -->
        </div>
        
        <div class="permission-change-section">
          <div class="current-permission">
            <label>Aktuelle Berechtigung:</label>
            <div id="current-permission-display" class="permission-display">
              <!-- Current permission will be shown here -->
            </div>
          </div>
          
          <div class="new-permission">
            <label>Neue Berechtigung:</label>
            <select id="edit-permission-select" class="enhanced-permission-select">
              <option value="R">Read-Only - Nur Anzeigen</option>
              <option value="W">Write - Zeichnen erlaubt</option>
              <option value="V">Voice - Auch in moderierten Canvas</option>
              <option value="M">Moderator - Moderation + Rechte vergeben</option>
              <option value="O">Owner - Vollzugriff</option>
            </select>
            <div class="permission-explanation">
              <span id="edit-permission-explanation-text">Wählen Sie eine neue Berechtigung aus</span>
            </div>
          </div>
          
          <div class="permission-change-warning" id="permission-change-warning" style="display:none;">
            <div class="warning-content">
              <span class="warning-icon">!</span>
              <div class="warning-text">
                <strong>Wichtiger Hinweis:</strong>
                <span id="warning-message">Diese Änderung wird sofort wirksam</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="modal-buttons">
          <button id="confirm-edit-permission" class="action-button create-button">Change Permission</button>
          <button id="cancel-edit-permission" class="action-button cancel-button">Abbrechen</button>
        </div>
      </div>
    </div>

    <!-- Confirmation Dialog Modal -->
    <div id="confirmation-modal" class="modal" style="display:none;">
      <div class="modal-content confirmation-modal-content">
        <div class="confirmation-header">
          <span id="confirmation-icon" class="confirmation-icon">!</span>
          <h3 id="confirmation-title">Aktion bestätigen</h3>
        </div>
        
        <div class="confirmation-body">
          <div id="confirmation-message" class="confirmation-message">
            <!-- Confirmation message will be populated here -->
          </div>
          
          <div id="confirmation-details" class="confirmation-details" style="display:none;">
            <!-- Additional details will be populated here -->
          </div>
        </div>
        
        <div class="modal-buttons">
          <button id="confirm-action" class="action-button delete-button">Bestätigen</button>
          <button id="cancel-action" class="action-button cancel-button">Abbrechen</button>
        </div>
      </div>
    </div>
  
  <!-- Drawing area only shown on canvas detail pages, not on main page -->
  
  <nav>
    <h3>Navigation</h3>
    <ul>
      <li><a href="hallo.html" class="spa-link">Go to Hello Page</a></li>
      <li><a href="about.html" class="spa-link">Go to About Page</a></li>
    </ul>
  </nav>
</div>

<style>
.header-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid #ddd;
}

.user-controls {
    display: flex;
    align-items: center;
    gap: 15px;
}

#user-info {
    color: #28a745;
    font-weight: bold;
}

.logout-button {
    padding: 8px 16px;
    background-color: #dc3545;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}

.logout-button:hover {
    background-color: #c82333;
}

.drawing-area-info {
    margin: 30px 0;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.drawing-container {
    margin: 20px 0;
    padding: 20px;
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 8px;
    display: flex;
    flex-wrap: wrap;
    align-items: flex-start;
    gap: 20px;
}

.tools {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 10px;
    min-width: 120px;
}

.tools li {
    padding: 8px 12px;
    background-color: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
    text-align: center;
    transition: background-color 0.2s;
}

.tools li:hover {
    background-color: #e9ecef;
}

.tools li.selected {
    background-color: #007bff;
    color: white;
}

#drawArea {
    border: 1px solid #ccc;
    cursor: crosshair;
}

#info-section {
    flex: 1;
    min-width: 200px;
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 4px;
}

.context-menu {
    background: white;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 5px 0;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    z-index: 1000;
}

nav h3 {
    color: #495057;
    margin-bottom: 10px;
}

nav ul {
    list-style: none;
    padding: 0;
}

nav li {
    margin: 8px 0;
}

nav a {
    color: #007bff;
    text-decoration: none;
    padding: 8px 12px;
    border-radius: 4px;
    transition: background-color 0.2s;
}

nav a:hover {
    background-color: #e9ecef;
    text-decoration: none;
}

/* A 5.4: Canvas Management Styles */
.canvas-management {
    margin: 30px 0;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

#canvas-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.action-button {
    padding: 10px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    transition: background-color 0.2s;
}

.create-button {
    background-color: #28a745;
    color: white;
}

.create-button:hover {
    background-color: #218838;
}

.refresh-button {
    background-color: #17a2b8;
    color: white;
}

.refresh-button:hover {
    background-color: #138496;
}

.edit-button {
    background-color: #ffc107;
    color: #212529;
}

.edit-button:hover {
    background-color: #e0a800;
}

.delete-button {
    background-color: #dc3545;
    color: white;
}

.delete-button:hover {
    background-color: #c82333;
}

.cancel-button {
    background-color: #6c757d;
    color: white;
}

.cancel-button:hover {
    background-color: #5a6268;
}

.canvas-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.canvas-card {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 16px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: box-shadow 0.2s;
}

.canvas-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.canvas-card h3 {
    margin: 0 0 10px 0;
    color: #343a40;
}

.canvas-card p {
    margin: 5px 0;
    font-size: 14px;
    color: #6c757d;
}

.permission-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
    text-transform: uppercase;
    margin-right: 8px;
}

.permission-R { background-color: #e9ecef; color: #495057; }
.permission-W { background-color: #d4edda; color: #155724; }
.permission-V { background-color: #cce5ff; color: #004085; }
.permission-M { background-color: #fff3cd; color: #856404; }
.permission-O { background-color: #f8d7da; color: #721c24; }

/* Enhanced permission styling with icons */
.permission-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.permission-badge::before {
    font-size: 14px;
}


.moderated-badge {
    background-color: #dc3545;
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: bold;
    margin-left: 8px;
}

.canvas-actions {
    margin-top: 12px;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.canvas-actions button {
    padding: 6px 12px;
    font-size: 12px;
}

.loading {
    text-align: center;
    color: #6c757d;
    font-style: italic;
    grid-column: 1 / -1;
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    padding: 24px;
    border-radius: 8px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    min-width: 400px;
}

.modal-content h3 {
    margin: 0 0 16px 0;
    color: #343a40;
}

.modal-content input {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 16px;
    font-size: 14px;
}

.modal-buttons {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

/* Permission Management Modal Styles */
.permission-modal-content {
    min-width: 650px;
    max-width: 850px;
    max-height: 85vh;
    overflow-y: auto;
    position: relative;
}

/* Edit Permission Modal Styles */
.edit-permission-modal-content {
    min-width: 500px;
    max-width: 600px;
    max-height: 70vh;
    overflow-y: auto;
}

/* Confirmation Modal Styles */
.confirmation-modal-content {
    min-width: 400px;
    max-width: 500px;
    text-align: center;
}

.confirmation-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid #e9ecef;
}

.confirmation-icon {
    font-size: 24px;
}

.confirmation-header h3 {
    margin: 0;
    flex: 1;
    text-align: left;
}

.confirmation-body {
    text-align: left;
    margin-bottom: 20px;
}

.confirmation-message {
    font-size: 16px;
    margin-bottom: 12px;
}

.confirmation-details {
    background-color: #f8f9fa;
    padding: 12px;
    border-radius: 4px;
    border-left: 4px solid #ffc107;
    font-size: 14px;
    color: #495057;
}

.confirmation-details ul {
    margin: 8px 0;
    padding-left: 20px;
}

.confirmation-details li {
    margin-bottom: 4px;
}

.permission-section {
    margin: 20px 0;
    padding: 16px;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    background-color: #f8f9fa;
}

.permission-section h4 {
    margin: 0 0 12px 0;
    color: #495057;
}

.user-search-section {
    position: relative;
    margin-bottom: 16px;
}

#user-search-input {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.user-list-container {
    border: 1px solid #ddd;
    border-radius: 4px;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-top: 8px;
}

.user-list {
    max-height: 250px;
    overflow-y: auto;
    border-radius: 4px;
}

.search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 4px 4px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    max-height: 200px;
    overflow-y: auto;
    z-index: 1001;
    display: none;
}

.user-list-item,
.search-result-item {
    padding: 10px;
    cursor: pointer;
    border-bottom: 1px solid #f1f1f1;
    transition: background-color 0.2s;
    outline: none;
}

.user-list-item:hover,
.user-list-item:focus,
.search-result-item:hover,
.search-result-item:focus {
    background-color: #e3f2fd;
    border-left: 3px solid #2196f3;
}

.user-list-item:last-child,
.search-result-item:last-child {
    border-bottom: none;
}

/* Screen reader only text */
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

/* Focus trap styles */
.modal.focus-trap {
    position: relative;
}

.modal-focusable {
    outline: none;
}

.modal-focusable:focus {
    box-shadow: 0 0 0 2px #007bff;
    outline: 2px solid transparent;
    outline-offset: 2px;
}

/* Enhanced button focus styles */
.action-button:focus {
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.5);
    outline: 2px solid transparent;
    outline-offset: 2px;
}

/* Enhanced select focus styles */
.enhanced-permission-select:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    outline: none;
}

/* Enhanced input focus styles */
input[type="text"]:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    outline: none;
}

.search-result-item .user-name {
    font-weight: bold;
    color: #343a40;
}

.user-list-item .user-name,
.search-result-item .user-name {
    font-weight: bold;
    color: #343a40;
}

.user-list-item .user-email,
.search-result-item .user-email {
    font-size: 12px;
    color: #6c757d;
}

.user-list .loading,
.user-list .no-users {
    padding: 20px;
    text-align: center;
    color: #6c757d;
    font-style: italic;
}

.permission-grant-section {
    padding: 12px;
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.selected-user {
    margin-bottom: 12px;
    padding: 8px;
    background-color: #e3f2fd;
    border-radius: 4px;
}

.permission-selector {
    margin-bottom: 12px;
}

.permission-selector label {
    display: block;
    margin-bottom: 4px;
    font-weight: bold;
    color: #495057;
}

.permission-selector select {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

/* Enhanced permission select styling */
.enhanced-permission-select {
    background-color: white;
    cursor: pointer;
    transition: border-color 0.2s, box-shadow 0.2s;
}

.enhanced-permission-select:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    outline: none;
}

.enhanced-permission-select option {
    padding: 8px;
}

.permission-explanation {
    margin-top: 8px;
    padding: 8px 12px;
    background-color: #e3f2fd;
    border: 1px solid #bbdefb;
    border-radius: 4px;
    font-size: 13px;
    color: #1976d2;
    min-height: 20px;
    transition: all 0.2s ease;
}

.permission-explanation.empty {
    opacity: 0.7;
    font-style: italic;
}

/* User info display */
.user-info-display {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.user-info-display .user-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 18px;
}

.user-info-display .user-details {
    flex: 1;
}

.user-info-display .user-name {
    font-weight: bold;
    font-size: 16px;
    color: #343a40;
    margin-bottom: 4px;
}

.user-info-display .user-email {
    color: #6c757d;
    font-size: 14px;
}

/* Permission change section */
.permission-change-section {
    margin: 20px 0;
}

.current-permission,
.new-permission {
    margin-bottom: 16px;
}

.current-permission label,
.new-permission label {
    display: block;
    margin-bottom: 8px;
    font-weight: bold;
    color: #495057;
}

.permission-display {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    font-size: 14px;
}

.permission-change-warning {
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    padding: 12px;
    margin-top: 16px;
}

.warning-content {
    display: flex;
    align-items: flex-start;
    gap: 12px;
}

.warning-icon {
    font-size: 20px;
    margin-top: 2px;
}

.warning-text {
    flex: 1;
}

.warning-text strong {
    display: block;
    margin-bottom: 4px;
    color: #856404;
}

/* Loading states */
.loading-spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 8px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.action-button.loading {
    opacity: 0.7;
    cursor: not-allowed;
    position: relative;
}

.action-button.loading::before {
    content: '';
    position: absolute;
    left: 8px;
    top: 50%;
    transform: translateY(-50%);
    width: 16px;
    height: 16px;
    border: 2px solid transparent;
    border-top: 2px solid currentColor;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

.permission-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
}

.permissions-list {
    min-height: 100px;
}

.permission-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    margin-bottom: 8px;
    background-color: white;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.permission-user-info {
    flex: 1;
}

.permission-user-name {
    font-weight: bold;
    color: #343a40;
}

.permission-user-email {
    font-size: 12px;
    color: #6c757d;
}

.permission-level {
    margin: 0 12px;
}

.permission-item-actions {
    display: flex;
    gap: 4px;
}

.permission-item-actions button {
    padding: 4px 8px;
    font-size: 12px;
}

.canvas-info {
    margin-bottom: 16px;
    padding: 12px;
    background-color: #e9ecef;
    border-radius: 4px;
    font-weight: bold;
}

.loading-permissions {
    text-align: center;
    padding: 20px;
    color: #6c757d;
    font-style: italic;
}

/* Event Sourcing Styles */
.event-sourcing {
    margin-top: 20px;
    padding: 16px;
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
}

.event-sourcing h3 {
    margin: 0 0 12px 0;
    color: #495057;
}

.event-log-controls {
    margin-bottom: 12px;
    display: flex;
    gap: 8px;
}

.event-log-controls button {
    padding: 6px 12px;
    font-size: 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    background-color: #17a2b8;
    color: white;
    transition: background-color 0.2s;
}

.event-log-controls button:hover {
    background-color: #138496;
}

#event-log {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-family: monospace;
    font-size: 11px;
    background-color: #fff;
    resize: vertical;
}
</style>

<script>
// Execute immediately since DOM is already loaded in SPA context
(function() {
    const logoutBtn = document.getElementById('logout-btn');
    const userInfo = document.getElementById('user-info');
    
    // Load user information and canvas list
    loadUserInfo();
    loadCanvasList();
    
    // A 5.4: Canvas Management Event Listeners
    setupCanvasManagement();
    
    async function loadUserInfo() {
        try {
            const response = await fetch('/api/user-info', {
                method: 'GET',
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.display_name) {
                    userInfo.textContent = `Sie sind als ${data.display_name} eingeloggt`;
                } else {
                    userInfo.textContent = 'Sie sind eingeloggt';
                }
                
                // A 5.3: Canvas-Berechtigungen in Console ausgeben
                if (data.success && data.canvas_permissions) {
                    console.log('=== A 5.3: Canvas Permissions Data Structure ===');
                    console.log('Canvas permissions from JWT (after login/refresh):', data.canvas_permissions);
                    console.log('Structure: Liste von Canvas-IDs mit Berechtigungen (R, W, V, M, O)');
                    
                    // Formatierte Ausgabe für bessere Lesbarkeit
                    Object.entries(data.canvas_permissions).forEach(([canvasId, permission]) => {
                        const permissionNames = {
                            'R': 'Read-Only',
                            'W': 'Write', 
                            'V': 'Voice (moderated write)',
                            'M': 'Moderator',
                            'O': 'Owner'
                        };
                        console.log(`  Canvas: ${canvasId} -> Permission: ${permission} (${permissionNames[permission] || 'Unknown'})`);
                    });
                    console.log('=== Ende Canvas Permissions ===');
                }
            } else {
                userInfo.textContent = 'Sie sind eingeloggt';
            }
        } catch (error) {
            console.error('Error loading user info:', error);
            userInfo.textContent = 'Sie sind eingeloggt';
        }
    }
    
    logoutBtn.addEventListener('click', async function() {
        try {
            const response = await fetch('/api/logout', {
                method: 'POST',
                credentials: 'include'
            });
            
            // Always redirect to login, regardless of response
            // This handles cases where cookies might be stale
            if (window.navigateTo) {
                window.navigateTo('/login');
            } else {
                window.location.href = '/login';
            }
            
        } catch (error) {
            console.error('Logout error:', error);
            // Still redirect on error
            if (window.navigateTo) {
                window.navigateTo('/login');
            } else {
                window.location.href = '/login';
            }
        }
    });

    // Drawing functionality will be initialized on canvas detail pages only
    
    // ============================================================================
    // A 5.4: Canvas Management Functions
    // ============================================================================
    
    async function loadCanvasList() {
        const canvasListElement = document.getElementById('canvas-list');
        canvasListElement.innerHTML = '<div class="loading">Lade Zeichenflächen...</div>';
        
        try {
            const response = await fetch('/api/canvas', {
                method: 'GET',
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                displayCanvasList(data.canvas || []);
            } else {
                canvasListElement.innerHTML = '<div class="loading">Fehler beim Laden der Zeichenflächen</div>';
            }
        } catch (error) {
            console.error('Error loading canvas list:', error);
            canvasListElement.innerHTML = '<div class="loading">Fehler beim Laden der Zeichenflächen</div>';
        }
    }
    
    function displayCanvasList(canvasList) {
        const canvasListElement = document.getElementById('canvas-list');
        
        if (canvasList.length === 0) {
            canvasListElement.innerHTML = '<div class="loading">Keine Zeichenflächen gefunden. Erstellen Sie Ihre erste!</div>';
            return;
        }
        
        canvasListElement.innerHTML = canvasList.map(canvas => createCanvasCard(canvas)).join('');
    }
    
    function createCanvasCard(canvas) {
        const permissionNames = {
            'R': 'Read-Only',
            'W': 'Write',
            'V': 'Voice (moderated write)',
            'M': 'Moderator',
            'O': 'Owner'
        };
        
        const permissionName = permissionNames[canvas.your_permission] || canvas.your_permission;
        const canModerate = ['M', 'O'].includes(canvas.your_permission);
        const canEdit = ['W', 'V', 'M', 'O'].includes(canvas.your_permission);
        const canView = ['R', 'W', 'V', 'M', 'O'].includes(canvas.your_permission);
        const isOwner = canvas.your_permission === 'O';
        
        const moderatedBadge = canvas.is_moderated ? '<span class="moderated-badge">MODERIERT</span>' : '';
        
        let actionButtons = '';
        if (canView) {
            const buttonText = canEdit ? 'Öffnen' : 'Anzeigen';
            actionButtons += `<button class="action-button edit-button" onclick="openCanvas('${canvas.id}')">${buttonText}</button>`;
        }
        if (canModerate) {
            const toggleText = canvas.is_moderated ? 'Demoderation' : 'Moderieren';
            actionButtons += `<button class="action-button edit-button" onclick="toggleModeration('${canvas.id}', ${!canvas.is_moderated})">${toggleText}</button>`;
        }
        if (isOwner) {
            actionButtons += `<button class="action-button edit-button" onclick="managePermissions('${canvas.id}')">Berechtigungen</button>`;
            actionButtons += `<button class="action-button delete-button" onclick="deleteCanvas('${canvas.id}', '${canvas.name}')">Löschen</button>`;
        }
        
        return `
            <div class="canvas-card">
                <h3>${canvas.name} ${moderatedBadge}</h3>
                <p><strong>Berechtigung:</strong> <span class="permission-badge permission-${canvas.your_permission}">${canvas.your_permission}</span> ${permissionName}</p>
                <p><strong>Erstellt:</strong> ${new Date(canvas.created_at).toLocaleDateString()}</p>
                <div class="canvas-actions">
                    ${actionButtons}
                </div>
            </div>
        `;
    }
    
    function setupCanvasManagement() {
        // Create Canvas Button
        document.getElementById('create-canvas-btn').addEventListener('click', () => {
            document.getElementById('create-canvas-modal').style.display = 'flex';
            document.getElementById('new-canvas-name').focus();
        });
        
        // Refresh Canvas List Button
        document.getElementById('refresh-canvas-btn').addEventListener('click', loadCanvasList);
        
        // Modal Controls
        document.getElementById('cancel-create-canvas').addEventListener('click', () => {
            document.getElementById('create-canvas-modal').style.display = 'none';
            document.getElementById('new-canvas-name').value = '';
        });
        
        document.getElementById('confirm-create-canvas').addEventListener('click', createNewCanvas);
        
        // Allow Enter key in modal
        document.getElementById('new-canvas-name').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                createNewCanvas();
            }
        });
        
        // Close modal on outside click
        document.getElementById('create-canvas-modal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                document.getElementById('create-canvas-modal').style.display = 'none';
                document.getElementById('new-canvas-name').value = '';
            }
        });
    }
    
    async function createNewCanvas() {
        const nameInput = document.getElementById('new-canvas-name');
        const name = nameInput.value.trim();
        
        if (!name) {
            alert('Bitte geben Sie einen Namen für die Zeichenfläche ein.');
            return;
        }
        
        if (name.length > 100) {
            alert('Der Name darf maximal 100 Zeichen lang sein.');
            return;
        }
        
        try {
            const response = await fetch('/api/canvas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({ name })
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                // Close modal
                document.getElementById('create-canvas-modal').style.display = 'none';
                nameInput.value = '';
                
                // Reload canvas list
                loadCanvasList();
            } else {
                alert('Fehler beim Erstellen der Zeichenfläche: ' + data.message);
            }
        } catch (error) {
            console.error('Error creating canvas:', error);
            alert('Fehler beim Erstellen der Zeichenfläche.');
        }
    }
    
    // Global functions for button actions
    window.openCanvas = function(canvasId) {
        // Navigate to canvas detail page
        if (window.navigateTo) {
            window.navigateTo(`/canvas/${canvasId}`);
        } else {
            window.location.href = `/canvas/${canvasId}`;
        }
    };
    
    window.toggleModeration = async function(canvasId, setModerated) {
        try {
            const response = await fetch(`/api/canvas/${canvasId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({ is_moderated: setModerated })
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                loadCanvasList(); // Reload to show updated status
                const action = setModerated ? 'moderiert' : 'demoderiiert';
                alert(`Zeichenfläche wurde erfolgreich ${action}.`);
            } else {
                alert('Fehler beim Ändern des Moderations-Status: ' + data.message);
            }
        } catch (error) {
            console.error('Error toggling moderation:', error);
            alert('Fehler beim Ändern des Moderations-Status.');
        }
    };
    
    window.managePermissions = function(canvasId) {
        openPermissionModal(canvasId);
    };
    
    window.deleteCanvas = async function(canvasId, canvasName) {
        if (!confirm(`Möchten Sie die Zeichenfläche "${canvasName}" wirklich löschen?\n\nDiese Aktion kann nicht rückgängig gemacht werden und alle zugehörigen Daten gehen verloren.`)) {
            return;
        }
        
        try {
            const response = await fetch(`/api/canvas/${canvasId}`, {
                method: 'DELETE',
                credentials: 'include'
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                alert('Zeichenfläche wurde erfolgreich gelöscht.');
                loadCanvasList(); // Reload to remove deleted canvas
            } else {
                alert('Fehler beim Löschen der Zeichenfläche: ' + data.message);
            }
        } catch (error) {
            console.error('Error deleting canvas:', error);
            alert('Fehler beim Löschen der Zeichenfläche.');
        }
    };
    
    // ============================================================================
    // PERMISSION MANAGEMENT FUNCTIONS
    // ============================================================================
    
    let currentCanvasId = null;
    let selectedUserId = null;
    let userSearchTimeout = null;
    let userCache = new Map(); // Cache für User ID -> Display Name Mapping
    
    async function openPermissionModal(canvasId) {
        console.log('Opening permission modal for canvas:', canvasId);
        currentCanvasId = canvasId;
        
        // Modal anzeigen with accessibility setup
        const modal = document.getElementById('permission-modal');
        if (modal) {
            modal.style.display = 'flex';
            const originalFocus = setupModalAccessibility('permission-modal');
            modal.dataset.originalFocus = originalFocus;
            console.log('Permission modal displayed with accessibility features');
        } else {
            console.error('Permission modal element not found!');
            return;
        }
        
        // Canvas-Informationen laden
        await loadCanvasInfoForModal(canvasId);
        
        // Initiale Benutzerliste laden (vor Berechtigungen für userCache)
        await loadInitialUserList();
        
        // Bestehende Berechtigungen laden
        await loadExistingPermissions(canvasId);
        
        // Event Listeners einrichten
        setupPermissionModalEventListeners();
        
        // User search input fokussieren and setup accessibility
        const searchInput = document.getElementById('user-search-input');
        if (searchInput) {
            // Focus with delay to ensure modal is fully rendered
            setTimeout(() => {
                searchInput.focus();
                console.log('Search input focused');
            }, 100);
            
            // Add ARIA attributes for better accessibility
            searchInput.setAttribute('aria-label', 'Benutzer für Berechtigung suchen');
            searchInput.setAttribute('aria-describedby', 'user-search-help');
            
            // Add helper text for screen readers
            if (!document.getElementById('user-search-help')) {
                const helpText = document.createElement('div');
                helpText.id = 'user-search-help';
                helpText.className = 'sr-only';
                helpText.textContent = 'Geben Sie mindestens 2 Zeichen ein, um nach Benutzern zu suchen';
                searchInput.parentElement.appendChild(helpText);
            }
        } else {
            console.error('user-search-input element not found!');
        }
    }
    
    async function loadCanvasInfoForModal(canvasId) {
        try {
            const response = await fetch(`/api/canvas/${canvasId}`, {
                method: 'GET',
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.canvas) {
                    const canvas = data.canvas;
                    document.getElementById('permission-modal-canvas-info').innerHTML = `
                        Canvas: <strong>${canvas.name}</strong> (ID: ${canvas.id})
                        ${canvas.is_moderated ? '<span class="moderated-badge">MODERIERT</span>' : ''}
                    `;
                }
            }
        } catch (error) {
            console.error('Error loading canvas info:', error);
        }
    }
    
    async function loadExistingPermissions(canvasId) {
        const permissionsContainer = document.getElementById('existing-permissions');
        permissionsContainer.innerHTML = '<div class="loading-permissions"><span class="loading-spinner"></span>Lade Berechtigungen...</div>';
        
        try {
            const response = await fetch(`/api/canvas/${canvasId}`, {
                method: 'GET',
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                console.log('Canvas API Response:', data);
                
                if (data.success && data.canvas && data.canvas.all_permissions) {
                    console.log('Permissions data structure:', data.canvas.all_permissions);
                    console.log('Type of permissions:', typeof data.canvas.all_permissions);
                    displayExistingPermissions(data.canvas.all_permissions);
                } else {
                    console.log('No permissions found in API response');
                    permissionsContainer.innerHTML = '<div class="loading-permissions">Keine Berechtigungen sichtbar</div>';
                }
            } else {
                console.error('Canvas API Error:', response.status, response.statusText);
                permissionsContainer.innerHTML = '<div class="loading-permissions">Fehler beim Laden der Berechtigungen</div>';
            }
        } catch (error) {
            console.error('Error loading permissions:', error);
            permissionsContainer.innerHTML = '<div class="loading-permissions">Fehler beim Laden der Berechtigungen</div>';
        }
    }
    
    function displayExistingPermissions(permissions) {
        const permissionsContainer = document.getElementById('existing-permissions');
        
        console.log('displayExistingPermissions called with:', permissions);
        console.log('Type of permissions parameter:', typeof permissions);
        
        if (!permissions || permissions.length === 0) {
            permissionsContainer.innerHTML = '<div class="loading-permissions">Keine Berechtigungen vorhanden</div>';
            return;
        }
        
        const permissionNames = {
            'R': 'Read-Only',
            'W': 'Write',
            'V': 'Voice (moderated write)',
            'M': 'Moderator',
            'O': 'Owner'
        };
        
        const html = permissions.map((permissionData) => {
            const userId = permissionData.user_id;
            const permission = permissionData.permission || 'R';
            
            console.log(`Processing userId: ${userId}, permission: ${permission}`);
            
            console.log(`Extracted permission for ${userId}:`, permission);
            
            return `
                <div class="permission-item" data-user-id="${userId}">
                    <div class="permission-user-info">
                        <div class="permission-user-name">${userCache.get(userId) || `User ${userId}`}</div>
                    </div>
                    <div class="permission-level">
                        <span class="permission-badge permission-${permission}">${permission}</span>
                        ${permissionNames[permission] || permission}
                    </div>
                    <div class="permission-item-actions">
                        <button class="action-button edit-button" onclick="editPermission('${userId}', '${permission}')">Ändern</button>
                        <button class="action-button delete-button" onclick="removePermission('${userId}')">Entfernen</button>
                    </div>
                </div>
            `;
        }).join('');
        
        permissionsContainer.innerHTML = html;
        
        // User-Cache wird bereits beim Laden des Modals gefüllt - keine zusätzlichen API-Calls nötig
    }
    
    // loadUserInfoForPermission entfernt - wird durch User-Cache ersetzt
    
    // Lädt die ersten Benutzer beim Öffnen des Modals
    async function loadInitialUserList() {
        const userList = document.getElementById('user-list');
        
        try {
            userList.innerHTML = '<div class="loading">Lade Benutzer...</div>';
            
            const response = await fetch('/api/users/list?limit=20', {
                method: 'GET',
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.users) {
                    // User-Cache füllen
                    data.users.forEach(user => {
                        userCache.set(user.user_id, user.display_name);
                    });
                    await displayUserList(data.users);
                } else {
                    userList.innerHTML = '<div class="no-users">Keine Benutzer gefunden</div>';
                }
            } else {
                userList.innerHTML = '<div class="no-users">Fehler beim Laden der Benutzer</div>';
            }
        } catch (error) {
            console.error('Error loading initial user list:', error);
            userList.innerHTML = '<div class="no-users">Fehler beim Laden der Benutzer</div>';
        }
    }
    
    // Get current user ID from API
    async function getCurrentUserId() {
        try {
            const response = await fetch('/api/user-info', {
                method: 'GET',
                credentials: 'include'
            });
            if (response.ok) {
                const data = await response.json();
                return data.success ? data.user_id : null;
            }
        } catch (error) {
            console.error('Error getting current user ID:', error);
        }
        return null;
    }

    // Zeigt die Benutzerliste an (ohne aktuellen Benutzer)
    async function displayUserList(users) {
        const userList = document.getElementById('user-list');
        
        // Filter current user out
        const currentUserId = await getCurrentUserId();
        const filteredUsers = currentUserId ? users.filter(user => user.user_id !== currentUserId) : users;
        
        if (filteredUsers.length === 0) {
            userList.innerHTML = '<div class="no-users">Keine anderen Benutzer gefunden</div>';
            return;
        }
        
        const html = filteredUsers.map(user => `
            <div class="user-list-item" data-user-id="${user.user_id}" data-display-name="${user.display_name}">
                <div class="user-name">${user.display_name}</div>
            </div>
        `).join('');
        
        userList.innerHTML = html;
        
        // Event delegation für User-Auswahl
        userList.onclick = (e) => {
            const userItem = e.target.closest('.user-list-item');
            if (userItem) {
                const userId = userItem.dataset.userId;
                const displayName = userItem.dataset.displayName;
                window.selectUser(userId, displayName);
            }
        };
    }
    
    function setupPermissionModalEventListeners() {
        console.log('Setting up permission modal event listeners...');
        
        // Close modal
        const closeBtn = document.getElementById('close-permission-modal');
        if (closeBtn) {
            closeBtn.onclick = closePermissionModal;
            console.log('Close button listener attached');
        } else {
            console.error('close-permission-modal button not found!');
        }
        
        // User search
        const searchInput = document.getElementById('user-search-input');
        if (searchInput) {
            searchInput.oninput = handleUserSearch;
            searchInput.onblur = () => {
                // Delay hiding results to allow click
                setTimeout(() => {
                    const searchResults = document.getElementById('user-search-results');
                    if (searchResults) {
                        searchResults.style.display = 'none';
                    }
                }, 300);
            };
            console.log('Search input listeners attached');
        } else {
            console.error('user-search-input element not found!');
        }
        
        // Grant permission button
        const grantBtn = document.getElementById('grant-permission-btn');
        if (grantBtn) {
            grantBtn.onclick = grantPermission;
            console.log('Grant button listener attached');
        } else {
            console.error('grant-permission-btn button not found!');
        }
        
        // Permission select change handler for explanation
        const permissionSelect = document.getElementById('permission-select');
        if (permissionSelect) {
            permissionSelect.onchange = function() {
                const selectedPermission = this.value;
                const permissionInfo = getPermissionInfo(selectedPermission);
                const explanationElement = document.getElementById('permission-explanation-text');
                if (explanationElement) {
                    explanationElement.textContent = permissionInfo.description;
                }
            };
            // Trigger initial explanation
            permissionSelect.dispatchEvent(new Event('change'));
        }
        
        // Cancel grant button  
        const cancelBtn = document.getElementById('cancel-grant-btn');
        if (cancelBtn) {
            cancelBtn.onclick = cancelPermissionGrant;
            console.log('Cancel button listener attached');
        } else {
            console.error('cancel-grant-btn button not found!');
        }
        
        // Close modal on outside click and keyboard navigation
        const modal = document.getElementById('permission-modal');
        if (modal) {
            modal.onclick = (e) => {
                if (e.target === e.currentTarget) {
                    closePermissionModal();
                }
            };
            
            // Enhanced keyboard navigation
            modal.onkeydown = (e) => {
                if (e.key === 'Escape') {
                    closePermissionModal();
                } else if (e.key === 'Tab') {
                    handleModalTabNavigation(e, modal);
                }
            };
            
            console.log('Modal outside click and keyboard listeners attached');
        } else {
            console.error('permission-modal element not found!');
        }
        
        console.log('Permission modal event listeners setup complete');
    }
    
    function handleUserSearch(e) {
        const query = e.target.value.trim();
        console.log('User search triggered with query:', query);
        
        if (userSearchTimeout) {
            clearTimeout(userSearchTimeout);
        }
        
        if (query.length === 0) {
            // Zeige initiale Benutzerliste
            loadInitialUserList();
            return;
        }
        
        if (query.length < 2) {
            // Query zu kurz, aber nicht leer - zeige "keine Ergebnisse"
            const userList = document.getElementById('user-list');
            userList.innerHTML = '<div class="no-users">Mindestens 2 Zeichen eingeben</div>';
            return;
        }
        
        console.log('Setting timeout for search...');
        userSearchTimeout = setTimeout(() => {
            searchUsers(query);
        }, 300);
    }
    
    async function searchUsers(query) {
        try {
            const response = await fetch(`/api/users/search?q=${encodeURIComponent(query)}`, {
                method: 'GET',
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    // User-Cache auch mit Suchergebnissen füllen
                    data.users.forEach(user => {
                        userCache.set(user.user_id, user.display_name);
                    });
                    await displayUserList(data.users);
                } else {
                    const userList = document.getElementById('user-list');
                    userList.innerHTML = '<div class="no-users">Suchfehler: ' + data.message + '</div>';
                }
            } else {
                const userList = document.getElementById('user-list');
                userList.innerHTML = '<div class="no-users">Suchfehler: Server nicht erreichbar</div>';
            }
        } catch (error) {
            console.error('Error searching users:', error);
            const userList = document.getElementById('user-list');
            userList.innerHTML = '<div class="no-users">Suchfehler: ' + error.message + '</div>';
        }
    }
    
    async function displayUserSearchResults(users) {
        const resultsContainer = document.getElementById('user-search-results');
        
        // Filter current user out
        const currentUserId = await getCurrentUserId();
        const filteredUsers = currentUserId ? users.filter(user => user.user_id !== currentUserId) : users;
        
        if (filteredUsers.length === 0) {
            resultsContainer.innerHTML = '<div style="padding: 10px; color: #6c757d;">Keine anderen Benutzer gefunden</div>';
            resultsContainer.style.display = 'block';
            return;
        }
        
        const html = filteredUsers.map((user, index) => `
            <div class="search-result-item" data-user-id="${user.user_id}" data-display-name="${user.display_name}" data-index="${index}">
                <div class="user-name">${user.display_name}</div>
            </div>
        `).join('');
        
        resultsContainer.innerHTML = html;
        resultsContainer.style.display = 'block';
        
        // Enhanced event delegation for search results with accessibility
        resultsContainer.onclick = (e) => {
            const resultItem = e.target.closest('.search-result-item');
            if (resultItem) {
                const userId = resultItem.dataset.userId;
                const displayName = resultItem.dataset.displayName;
                console.log('Search result clicked:', { userId, displayName });
                window.selectUser(userId, displayName);
            }
        };
        
        // Keyboard navigation for search results
        resultsContainer.onkeydown = (e) => {
            const items = resultsContainer.querySelectorAll('.search-result-item');
            const currentIndex = Array.from(items).findIndex(item => item === document.activeElement);
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                const nextIndex = (currentIndex + 1) % items.length;
                items[nextIndex]?.focus();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                const prevIndex = currentIndex <= 0 ? items.length - 1 : currentIndex - 1;
                items[prevIndex]?.focus();
            } else if (e.key === 'Enter' && currentIndex >= 0) {
                e.preventDefault();
                items[currentIndex].click();
            } else if (e.key === 'Escape') {
                resultsContainer.style.display = 'none';
                document.getElementById('user-search-input').focus();
            }
        };
        
        // Add tabindex and ARIA attributes to search result items
        const resultItems = resultsContainer.querySelectorAll('.search-result-item');
        resultItems.forEach((item, index) => {
            item.setAttribute('tabindex', '0');
            item.setAttribute('role', 'option');
            item.setAttribute('aria-label', `Benutzer auswählen: ${item.dataset.displayName}`);
        });
        
        // Update ARIA attributes for the container
        resultsContainer.setAttribute('role', 'listbox');
        resultsContainer.setAttribute('aria-label', 'Suchergebnisse für Benutzer');
    }
    
    window.selectUser = function(userId, displayName) {
        console.log('selectUser called with:', { userId, displayName });
        selectedUserId = userId;
        
        // Search results verstecken
        const searchResults = document.getElementById('user-search-results');
        if (searchResults) {
            searchResults.style.display = 'none';
            console.log('Search results hidden');
        } else {
            console.error('user-search-results element not found');
        }
        
        // Grant section anzeigen
        const grantSection = document.getElementById('permission-grant-section');
        if (grantSection) {
            grantSection.style.display = 'block';
            console.log('Grant section shown');
        } else {
            console.error('permission-grant-section element not found');
        }
        
        const userDisplay = document.getElementById('selected-user-display');
        if (userDisplay) {
            userDisplay.textContent = displayName;
            console.log('User display updated');
        } else {
            console.error('selected-user-display element not found');
        }
        
        // Search input leeren
        const searchInput = document.getElementById('user-search-input');
        if (searchInput) {
            searchInput.value = '';
            console.log('Search input cleared');
        } else {
            console.error('user-search-input element not found');
        }
    }
    
    async function grantPermission() {
        if (!selectedUserId || !currentCanvasId) {
            showErrorMessage('Fehler: Kein Benutzer oder Canvas ausgewählt');
            return;
        }
        
        const permission = document.getElementById('permission-select').value;
        const grantButton = document.getElementById('grant-permission-btn');
        
        // Add loading state
        grantButton.classList.add('loading');
        grantButton.disabled = true;
        grantButton.textContent = '⏳ Erteilt...';
        
        try {
            const response = await fetch(`/api/canvas-permissions/${currentCanvasId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    user_id: selectedUserId,
                    permission: permission
                })
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                const userName = document.getElementById('selected-user-display').textContent;
                showSuccessMessage(`Berechtigung für ${userName} erfolgreich erteilt!`);
                
                // Modal UI zurücksetzen
                cancelPermissionGrant();
                
                // Berechtigungen neu laden
                await loadExistingPermissions(currentCanvasId);
            } else {
                showErrorMessage('Fehler beim Erteilen der Berechtigung: ' + data.message);
            }
        } catch (error) {
            console.error('Error granting permission:', error);
            showErrorMessage('Fehler beim Erteilen der Berechtigung');
        } finally {
            // Remove loading state
            grantButton.classList.remove('loading');
            grantButton.disabled = false;
            grantButton.textContent = 'Grant Permission';
        }
    }
    
    function cancelPermissionGrant() {
        selectedUserId = null;
        
        const grantSection = document.getElementById('permission-grant-section');
        if (grantSection) {
            grantSection.style.display = 'none';
        }
        
        const searchInput = document.getElementById('user-search-input');
        if (searchInput) {
            searchInput.value = '';
        }
        
        const searchResults = document.getElementById('user-search-results');
        if (searchResults) {
            searchResults.style.display = 'none';
        }
        
        const permissionSelect = document.getElementById('permission-select');
        if (permissionSelect) {
            permissionSelect.value = 'R';
        }
    }
    
    function closePermissionModal() {
        const modal = document.getElementById('permission-modal');
        modal.style.display = 'none';
        
        // Restore focus to the trigger element
        const originalFocus = modal.dataset.originalFocus;
        if (originalFocus && originalFocus !== 'BODY') {
            const elementToFocus = document.querySelector(originalFocus);
            if (elementToFocus) {
                setTimeout(() => elementToFocus.focus(), 100);
            }
        }
        
        cancelPermissionGrant();
        currentCanvasId = null;
    }
    
    // Edit Permission Modal Functions
    let editingUserId = null;
    let editingCurrentPermission = null;
    
    async function openEditPermissionModal(userId, currentPermission) {
        console.log('Opening edit permission modal for:', userId, currentPermission);
        editingUserId = userId;
        editingCurrentPermission = currentPermission;
        
        // Get user info
        const userInfo = await getUserInfo(userId);
        
        // Populate modal
        const modal = document.getElementById('edit-permission-modal');
        const userInfoDisplay = document.getElementById('edit-permission-user-info');
        const currentPermissionDisplay = document.getElementById('current-permission-display');
        const editPermissionSelect = document.getElementById('edit-permission-select');
        
        // User info
        if (userInfo) {
            const initials = userInfo.display_name.split(' ').map(n => n[0]).join('').toUpperCase();
            userInfoDisplay.innerHTML = `
                <div class="user-avatar">${initials}</div>
                <div class="user-details">
                    <div class="user-name">${userInfo.display_name}</div>
                </div>
            `;
        } else {
            userInfoDisplay.innerHTML = `
                <div class="user-avatar">?</div>
                <div class="user-details">
                    <div class="user-name">User ${userId}</div>
                </div>
            `;
        }
        
        // Current permission
        const permissionInfo = getPermissionInfo(currentPermission);
        currentPermissionDisplay.innerHTML = `
            <span class="permission-badge permission-${currentPermission}">${currentPermission}</span>
            ${permissionInfo.name}
        `;
        
        // Set current selection and trigger change event
        editPermissionSelect.value = currentPermission;
        editPermissionSelect.dispatchEvent(new Event('change'));
        
        // Setup event listeners
        setupEditPermissionEventListeners();
        
        // Show modal with accessibility setup
        modal.style.display = 'flex';
        const originalFocus = setupModalAccessibility('edit-permission-modal');
        modal.dataset.originalFocus = originalFocus;
        
        // Focus on select with delay
        setTimeout(() => editPermissionSelect.focus(), 100);
    }
    
    function setupEditPermissionEventListeners() {
        const editPermissionSelect = document.getElementById('edit-permission-select');
        const confirmButton = document.getElementById('confirm-edit-permission');
        const cancelButton = document.getElementById('cancel-edit-permission');
        const modal = document.getElementById('edit-permission-modal');
        const explanationText = document.getElementById('edit-permission-explanation-text');
        const warningSection = document.getElementById('permission-change-warning');
        const warningMessage = document.getElementById('warning-message');
        
        // Permission selection change
        editPermissionSelect.onchange = function() {
            const selectedPermission = this.value;
            const permissionInfo = getPermissionInfo(selectedPermission);
            explanationText.textContent = permissionInfo.description;
            
            // Show warning if changing to/from critical permissions
            const showWarning = (selectedPermission !== editingCurrentPermission) && 
                                (selectedPermission === 'O' || editingCurrentPermission === 'O' || 
                                 selectedPermission === 'M' || editingCurrentPermission === 'M');
            
            if (showWarning) {
                let warning = 'Diese Änderung wird sofort wirksam';
                if (selectedPermission === 'O') {
                    warning = 'Owner-Rechte geben vollständige Kontrolle über das Canvas';
                } else if (editingCurrentPermission === 'O') {
                    warning = 'Owner-Rechte werden entzogen - Benutzer verliert administrative Kontrolle';
                } else if (selectedPermission === 'M') {
                    warning = 'Moderator-Rechte ermöglichen Moderation und Rechtevergabe';
                } else if (editingCurrentPermission === 'M') {
                    warning = 'Moderator-Rechte werden entzogen';
                }
                warningMessage.textContent = warning;
                warningSection.style.display = 'block';
            } else {
                warningSection.style.display = 'none';
            }
        };
        
        // Confirm button
        confirmButton.onclick = function() {
            const newPermission = editPermissionSelect.value;
            if (newPermission !== editingCurrentPermission) {
                confirmEditPermission(editingUserId, newPermission);
            } else {
                closeEditPermissionModal();
            }
        };
        
        // Cancel button
        cancelButton.onclick = closeEditPermissionModal;
        
        // Close on outside click
        modal.onclick = function(e) {
            if (e.target === e.currentTarget) {
                closeEditPermissionModal();
            }
        };
        
        // Keyboard navigation
        modal.onkeydown = function(e) {
            if (e.key === 'Escape') {
                closeEditPermissionModal();
            } else if (e.key === 'Enter' && e.target === editPermissionSelect) {
                confirmButton.click();
            }
        };
    }
    
    async function confirmEditPermission(userId, newPermission) {
        const confirmButton = document.getElementById('confirm-edit-permission');
        const userInfo = await getUserInfo(userId);
        const userName = userInfo ? userInfo.display_name : `User ${userId}`;
        
        // Add loading state
        confirmButton.classList.add('loading');
        confirmButton.disabled = true;
        confirmButton.textContent = '⏳ Ändert...';
        
        try {
            await grantPermissionForUser(userId, newPermission);
            closeEditPermissionModal();
            showSuccessMessage(`Berechtigung für ${userName} erfolgreich geändert!`);
        } catch (error) {
            console.error('Error updating permission:', error);
            showErrorMessage('Fehler beim Ändern der Berechtigung: ' + error.message);
        } finally {
            // Remove loading state
            confirmButton.classList.remove('loading');
            confirmButton.disabled = false;
            confirmButton.textContent = 'Change Permission';
        }
    }
    
    function closeEditPermissionModal() {
        const modal = document.getElementById('edit-permission-modal');
        modal.style.display = 'none';
        
        // Restore focus
        const originalFocus = modal.dataset.originalFocus;
        if (originalFocus && originalFocus !== 'BODY') {
            const elementToFocus = document.querySelector(originalFocus);
            if (elementToFocus) {
                setTimeout(() => elementToFocus.focus(), 100);
            }
        }
        
        editingUserId = null;
        editingCurrentPermission = null;
        
        // Reset warning
        document.getElementById('permission-change-warning').style.display = 'none';
        
        // Reset form
        document.getElementById('edit-permission-select').value = 'R';
        document.getElementById('edit-permission-explanation-text').textContent = 'Wählen Sie eine neue Berechtigung aus';
    }
    
    // Confirmation Dialog Functions
    let confirmationCallback = null;
    
    function showConfirmationDialog(options) {
        const modal = document.getElementById('confirmation-modal');
        const icon = document.getElementById('confirmation-icon');
        const title = document.getElementById('confirmation-modal-title') || document.getElementById('confirmation-title');
        const message = document.getElementById('confirmation-message');
        const details = document.getElementById('confirmation-details');
        const confirmButton = document.getElementById('confirm-action');
        const cancelButton = document.getElementById('cancel-action');
        
        // Set content
        icon.textContent = options.icon || '!';
        title.textContent = options.title || 'Aktion bestätigen';
        message.innerHTML = options.message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        
        // Set details if provided
        if (options.details && options.details.length > 0) {
            details.innerHTML = '<ul>' + options.details.map(detail => `<li>${detail}</li>`).join('') + '</ul>';
            details.style.display = 'block';
        } else {
            details.style.display = 'none';
        }
        
        // Set button text and style
        confirmButton.textContent = options.confirmText || 'Bestätigen';
        confirmButton.className = `action-button ${options.confirmClass || 'create-button'}`;
        
        // Store callback
        confirmationCallback = options.onConfirm;
        
        // Setup event listeners
        setupConfirmationEventListeners();
        
        // Show modal with accessibility setup
        modal.style.display = 'flex';
        const originalFocus = setupModalAccessibility('confirmation-modal');
        modal.dataset.originalFocus = originalFocus;
        
        // Focus on cancel button by default (safer)
        setTimeout(() => cancelButton.focus(), 100);
    }
    
    function setupConfirmationEventListeners() {
        const modal = document.getElementById('confirmation-modal');
        const confirmButton = document.getElementById('confirm-action');
        const cancelButton = document.getElementById('cancel-action');
        
        // Remove existing listeners
        confirmButton.onclick = null;
        cancelButton.onclick = null;
        modal.onkeydown = null;
        
        // Confirm button
        confirmButton.onclick = function() {
            if (confirmationCallback) {
                // Add loading state
                this.classList.add('loading');
                this.disabled = true;
                const originalText = this.textContent;
                this.textContent = '⏳ Verarbeitet...';
                
                Promise.resolve(confirmationCallback()).then(() => {
                    closeConfirmationModal();
                }).catch((error) => {
                    console.error('Confirmation callback error:', error);
                    showErrorMessage('Fehler beim Ausführen der Aktion: ' + error.message);
                }).finally(() => {
                    // Remove loading state
                    this.classList.remove('loading');
                    this.disabled = false;
                    this.textContent = originalText;
                });
            } else {
                closeConfirmationModal();
            }
        };
        
        // Cancel button
        cancelButton.onclick = closeConfirmationModal;
        
        // Keyboard navigation
        modal.onkeydown = function(e) {
            if (e.key === 'Escape') {
                closeConfirmationModal();
            } else if (e.key === 'Enter' && document.activeElement === confirmButton) {
                confirmButton.click();
            }
        };
        
        // Close on outside click
        modal.onclick = function(e) {
            if (e.target === e.currentTarget) {
                closeConfirmationModal();
            }
        };
    }
    
    function closeConfirmationModal() {
        const modal = document.getElementById('confirmation-modal');
        modal.style.display = 'none';
        
        // Restore focus
        const originalFocus = modal.dataset.originalFocus;
        if (originalFocus && originalFocus !== 'BODY') {
            const elementToFocus = document.querySelector(originalFocus);
            if (elementToFocus) {
                setTimeout(() => elementToFocus.focus(), 100);
            }
        }
        
        confirmationCallback = null;
    }
    
    // Global functions for permission management
    window.editPermission = function(userId, currentPermission) {
        openEditPermissionModal(userId, currentPermission);
    };
    
    window.removePermission = async function(userId) {
        // Find user info for better confirmation dialog
        const userInfo = await getUserInfo(userId);
        const userName = userInfo ? userInfo.display_name : `User ${userId}`;
        
        showConfirmationDialog({
            title: 'Berechtigung entfernen',
            icon: '!',
            message: `Möchten Sie die Berechtigung für **${userName}** wirklich entfernen?`,
            details: [
                `Benutzer: ${userName}`,
                'Der Benutzer verliert sofort den Zugriff auf dieses Canvas',
                'Aktuelle Zeichensitzung wird beendet',
                'Diese Aktion kann rückgängig gemacht werden'
            ],
            confirmText: 'Berechtigung entfernen',
            confirmClass: 'delete-button',
            onConfirm: async () => {
                await removeUserPermission(userId, userName);
            }
        });
    };
    
    // Helper function for editing permissions (reuses existing API call logic)
    async function grantPermissionForUser(userId, permission) {
        if (!currentCanvasId) {
            throw new Error('Keine Canvas ausgewählt');
        }
        
        const response = await fetch(`/api/canvas-permissions/${currentCanvasId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({
                user_id: userId,
                permission: permission
            })
        });
        
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.message || 'Unbekannter Fehler');
        }
        
        // Reload permissions after successful change
        await loadExistingPermissions(currentCanvasId);
    }
    
    // Remove user permission helper function
    async function removeUserPermission(userId, userName) {
        try {
            const response = await fetch(`/api/canvas-permissions/${currentCanvasId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    user_id: userId,
                    permission: 'REMOVE'
                })
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                showSuccessMessage(`Berechtigung für ${userName} erfolgreich entfernt!`);
                await loadExistingPermissions(currentCanvasId);
            } else {
                showErrorMessage('Fehler beim Entfernen der Berechtigung: ' + data.message);
            }
        } catch (error) {
            console.error('Error removing permission:', error);
            showErrorMessage('Fehler beim Entfernen der Berechtigung');
        }
    }
    
    // Get user info helper function
    async function getUserInfo(userId) {
        try {
            const response = await fetch(`/api/users/list`, {
                method: 'GET',
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.users) {
                    return data.users.find(u => u.user_id.toString() === userId.toString());
                }
            }
        } catch (error) {
            console.error('Error getting user info:', error);
        }
        return null;
    }
    
    // Permission info helper function
    function getPermissionInfo(permission) {
        const permissionInfo = {
            'R': { name: 'Read-Only', description: 'Benutzer kann das Canvas nur anzeigen, aber nicht bearbeiten', icon: 'R' },
            'W': { name: 'Write', description: 'Benutzer kann in normalen Canvas zeichnen und bearbeiten', icon: 'W' },
            'V': { name: 'Voice', description: 'Benutzer kann auch in moderierten Canvas schreiben', icon: 'V' },
            'M': { name: 'Moderator', description: 'Benutzer kann moderieren und Berechtigungen bis Voice vergeben', icon: 'M' },
            'O': { name: 'Owner', description: 'Benutzer hat vollständige Kontrolle über das Canvas', icon: 'O' }
        };
        return permissionInfo[permission] || { name: 'Unknown', description: 'Unknown permission', icon: '?' };
    }
    
    // Enhanced feedback functions
    function showSuccessMessage(message) {
        showTemporaryMessage(message, 'success', 'Success');
    }
    
    function showErrorMessage(message) {
        showTemporaryMessage(message, 'error', 'ERROR');
    }
    
    function showInfoMessage(message) {
        showTemporaryMessage(message, 'info', 'INFO');
    }
    
    function showTemporaryMessage(message, type = 'info', icon = 'INFO') {
        // Remove existing notifications
        const existingNotifications = document.querySelectorAll('.toast-notification');
        existingNotifications.forEach(notification => notification.remove());
        
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `toast-notification toast-${type}`;
        notification.innerHTML = `
            <span class="toast-icon">${icon}</span>
            <span class="toast-message">${message}</span>
            <button class="toast-close" onclick="this.parentElement.remove()">×</button>
        `;
        
        // Add styles if not already added
        if (!document.getElementById('toast-styles')) {
            const style = document.createElement('style');
            style.id = 'toast-styles';
            style.textContent = `
                .toast-notification {
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    max-width: 400px;
                    padding: 12px 16px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    z-index: 10000;
                    animation: slideInRight 0.3s ease-out;
                    font-size: 14px;
                    font-weight: 500;
                }
                
                .toast-success {
                    background-color: #d4edda;
                    color: #155724;
                    border: 1px solid #c3e6cb;
                }
                
                .toast-error {
                    background-color: #f8d7da;
                    color: #721c24;
                    border: 1px solid #f5c6cb;
                }
                
                .toast-info {
                    background-color: #d1ecf1;
                    color: #0c5460;
                    border: 1px solid #bee5eb;
                }
                
                .toast-icon {
                    font-size: 18px;
                    flex-shrink: 0;
                }
                
                .toast-message {
                    flex: 1;
                }
                
                .toast-close {
                    background: none;
                    border: none;
                    font-size: 18px;
                    cursor: pointer;
                    padding: 0;
                    margin-left: 8px;
                    opacity: 0.7;
                    transition: opacity 0.2s;
                }
                
                .toast-close:hover {
                    opacity: 1;
                }
                
                @keyframes slideInRight {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
            `;
            document.head.appendChild(style);
        }
        
        // Add to page
        document.body.appendChild(notification);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (notification.parentElement) {
                notification.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => notification.remove(), 300);
            }
        }, 5000);
    }
    // Modal focus management and accessibility functions
    function handleModalTabNavigation(e, modal) {
        const focusableElements = modal.querySelectorAll(
            'input:not([disabled]), button:not([disabled]), select:not([disabled]), ' +
            'textarea:not([disabled]), [tabindex]:not([tabindex="-1"]):not([disabled])'
        );
        
        const firstFocusable = focusableElements[0];
        const lastFocusable = focusableElements[focusableElements.length - 1];
        
        if (e.shiftKey) {
            // Shift + Tab - moving backwards
            if (document.activeElement === firstFocusable) {
                e.preventDefault();
                lastFocusable.focus();
            }
        } else {
            // Tab - moving forwards
            if (document.activeElement === lastFocusable) {
                e.preventDefault();
                firstFocusable.focus();
            }
        }
    }
    
    function setupModalAccessibility(modalId) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        
        // Add ARIA attributes
        modal.setAttribute('role', 'dialog');
        modal.setAttribute('aria-modal', 'true');
        modal.setAttribute('aria-labelledby', modalId + '-title');
        
        // Set up focus trap
        const originalActiveElement = document.activeElement;
        
        // Create a CSS selector for the original active element to restore focus later
        let originalFocusSelector = 'BODY';
        if (originalActiveElement && originalActiveElement.id) {
            originalFocusSelector = `#${originalActiveElement.id}`;
        } else if (originalActiveElement && originalActiveElement.tagName) {
            originalFocusSelector = originalActiveElement.tagName.toLowerCase();
        }
        modal.dataset.originalFocus = originalFocusSelector;
        
        // Find and focus the first focusable element
        const focusableElements = modal.querySelectorAll(
            'input:not([disabled]), button:not([disabled]), select:not([disabled]), ' +
            'textarea:not([disabled]), [tabindex]:not([tabindex="-1"]):not([disabled])'
        );
        
        if (focusableElements.length > 0) {
            // Focus the first input or the first button if no inputs
            const firstInput = modal.querySelector('input:not([disabled])');
            const firstButton = modal.querySelector('button:not([disabled])');
            const elementToFocus = firstInput || firstButton || focusableElements[0];
            
            setTimeout(() => elementToFocus.focus(), 100);
        }
        
        return originalFocusSelector;
    }
    
    function restoreModalFocus(originalActiveElement) {
        if (originalActiveElement && originalActiveElement.focus) {
            setTimeout(() => originalActiveElement.focus(), 100);
        }
    }
    
    // Apply accessibility enhancements to all modals
    setTimeout(() => {
        // Setup accessibility for permission management modal
        const permissionModal = document.getElementById('permission-modal');
        if (permissionModal) {
            const title = permissionModal.querySelector('h3');
            if (title) title.id = 'permission-modal-title';
        }
        
        // Setup accessibility for edit permission modal
        const editModal = document.getElementById('edit-permission-modal');
        if (editModal) {
            const title = editModal.querySelector('h3');
            if (title) title.id = 'edit-permission-modal-title';
        }
        
        // Setup accessibility for confirmation modal
        const confirmModal = document.getElementById('confirmation-modal');
        if (confirmModal) {
            const title = confirmModal.querySelector('h3');
            if (title) title.id = 'confirmation-modal-title';
        }
        
        console.log('Accessibility enhancements applied to modals');
    }, 500);
    
})();

// Load and initialize TypeScript drawing system
async function initializeTypeScriptDrawing() {
    try {
        console.log("Initialisiere TypeScript Drawing System...");
        
        // Check if required elements exist
        const drawArea = document.getElementById("drawArea");
        const toolsArea = document.querySelector(".tools");
        
        if (!drawArea) {
            throw new Error("Canvas-Element 'drawArea' nicht gefunden!");
        }
        
        if (!toolsArea) {
            throw new Error("Tools-Element '.tools' nicht gefunden!");
        }
        
        // Load the drawer system ES6 modules
        await loadDrawerSystem();
        
        // Load menu API
        await loadMenuApi();
        
        // Wait a bit for the systems to initialize
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Initialize drawer system
        if (typeof window.init === 'function') {
            console.log("Init-Funktion gefunden, rufe auf...");
            window.init();
            console.log("TypeScript Drawer successfully initialized");
        } else {
            throw new Error("Init-Funktion ist nicht verfügbar! Drawer System nicht geladen.");
        }
        
        // Add utility functions and event log setup
        await addDrawingUtilities();
        setupEventLogForIndex();
        
    } catch (error) {
        console.error("Fehler beim Initialisieren des TypeScript Drawing Systems:", error);
        // Fallback: Show error message to user
        const drawArea = document.getElementById("drawArea");
        if (drawArea) {
            const ctx = drawArea.getContext('2d');
            ctx.fillStyle = '#ff0000';
            ctx.font = '16px Arial';
            ctx.fillText('Fehler beim Laden der Zeichenfunktionalität', 10, 30);
            ctx.fillText('Siehe Konsole für Details', 10, 50);
        }
    }
}

// Load the drawer system ES6 modules and dependencies
async function loadDrawerSystem() {
    try {
        console.log("Lade Drawer System Module...");
        
        // Drawer State should be loaded via SPA architecture (app.js)
        // Just verify it's available
        if (window.drawerState) {
            console.log("Drawer State already available (via SPA)");
        } else {
            console.warn("Drawer State not available - will be loaded via SPA");
        }
        
        // Event System should be loaded via SPA architecture (app.js)
        // Just verify it's available
        if (window.eventBus && window.eventStore) {
            console.log("Event System already available (via SPA)");
        } else {
            console.warn("Event System not available - will be loaded via SPA");
        }
        
        // Import the main drawer module which provides window.init
        const drawerModule = await import('/scripts/drawer/index.js');
        console.log("Drawer System Module loaded");
        
        // Give the module time to set up window.init
        await new Promise(resolve => setTimeout(resolve, 50));
        
        return drawerModule;
    } catch (error) {
        console.error("Fehler beim Laden des Drawer Systems:", error);
        throw new Error(`Drawer System konnte nicht geladen werden: ${error.message}`);
    }
}

// Load menu-api function (same as in drawer_page.js)
function loadMenuApi() {
    return new Promise((resolve) => {
        import('/scripts/menu-api.js').then(module => {
            window.menuApi = module.default;
            console.log('Menu API loaded and available as window.menuApi');
            resolve();
        }).catch(err => {
            console.error('Error loading menu API:', err);
            resolve(); // Resolve anyway to continue initialization
        });
    });
}

// Add drawing utilities (simplified version of drawer_page.js functions)
async function addDrawingUtilities() {
    // Add mouse position tracking
    const mousePosition = document.getElementById('mouse-position');
    const drawArea = document.getElementById("drawArea");
    
    if (mousePosition && drawArea) {
        drawArea.addEventListener('mousemove', function(event) {
            const rect = drawArea.getBoundingClientRect();
            const x = Math.floor(event.clientX - rect.left);
            const y = Math.floor(event.clientY - rect.top);
            mousePosition.textContent = `${x}, ${y}`;
        });
        
        drawArea.addEventListener('mouseleave', function() {
            mousePosition.textContent = '---,---';
        });
    }
    
    // Update debug info
    const shapesCountEl = document.getElementById('saved-shapes-count');
    if (shapesCountEl) {
        const updateDebugInfo = () => {
            if (window.drawerState && window.drawerState.shapes) {
                const count = Object.keys(window.drawerState.shapes).length;
                shapesCountEl.textContent = count;
                shapesCountEl.style.color = count > 0 ? '#007700' : '#770000';
            }
        };
        
        // Update initially and on shape changes
        updateDebugInfo();
        
        // Listen for shape changes if event system is available
        if (window.eventBus) {
            window.eventBus.subscribe('SHAPE_ADDED', updateDebugInfo);
            window.eventBus.subscribe('SHAPE_REMOVED', updateDebugInfo);
        }
    }
    
    // Add reset button
    const infoSection = document.getElementById('info-section');
    if (infoSection) {
        const resetButton = document.createElement('button');
        resetButton.textContent = 'Zeichnung zurücksetzen';
        resetButton.style.marginTop = '20px';
        resetButton.style.padding = '8px 16px';
        resetButton.style.backgroundColor = '#dc3545';
        resetButton.style.color = 'white';
        resetButton.style.border = 'none';
        resetButton.style.borderRadius = '4px';
        resetButton.style.cursor = 'pointer';
        
        resetButton.addEventListener('click', function() {
            if (confirm('Möchten Sie wirklich die gesamte Zeichnung zurücksetzen? Diese Aktion kann nicht rückgängig gemacht werden.')) {
                try {
                    console.log("Versuche Zeichnung zurückzusetzen...");
                    
                    // Clear shapes if canvas is available
                    if (window.canvas && window.canvas.shapes) {
                        const shapeIds = Object.keys(window.canvas.shapes).map(id => parseInt(id));
                        console.log(`Entferne ${shapeIds.length} Shapes...`);
                        
                        shapeIds.forEach(id => {
                            window.canvas.removeShapeWithId(id, false);
                        });
                        
                        window.canvas.draw();
                    }
                    
                    // Reset drawer state
                    if (window.drawerState) {
                        console.log("Setze drawerState zurück...");
                        window.drawerState.reset();
                    }
                } catch (e) {
                    console.error("Fehler beim Zurücksetzen:", e);
                    alert('Fehler beim Zurücksetzen der Zeichnung: ' + e.message);
                }
            }
        });
        
        infoSection.appendChild(resetButton);
    }
}

// Setup event log (simplified version for index page)
function setupEventLogForIndex() {
    const eventLogTextarea = document.getElementById('event-log');
    const loadEventsBtn = document.getElementById('load-events-btn');
    const clearEventsBtn = document.getElementById('clear-events-btn');
    
    if (!eventLogTextarea || !loadEventsBtn || !clearEventsBtn) {
        console.log('Event log UI elements not found, skipping event log setup');
        return;
    }
    
    // Wait for event system to be ready
    const setupEventLogWhenReady = () => {
        if (window.eventBus && window.eventStore) {
            console.log("Event system available, setting up event log");
            
            // Update display when events change
            window.eventBus.subscribe('EVENT_LOG_UPDATED', () => {
                if (window.eventStore) {
                    eventLogTextarea.value = window.eventStore.getEventsAsString();
                }
            });
            
            // Load events button
            loadEventsBtn.addEventListener('click', () => {
                try {
                    const eventText = eventLogTextarea.value.trim();
                    if (!eventText) {
                        alert('Event log ist leer');
                        return;
                    }
                    
                    if (window.eventStore) {
                        window.eventStore.loadEvents(eventText);
                    }
                } catch (error) {
                    console.error('Failed to load events:', error);
                    alert(`Fehler beim Laden der Events: ${error.message}`);
                }
            });
            
            // Clear events button
            clearEventsBtn.addEventListener('click', () => {
                if (window.eventStore) {
                    if (confirm('Möchten Sie wirklich alle Events löschen?')) {
                        window.eventStore.clearEvents();
                    }
                }
            });
        } else {
            // Retry after a short delay
            setTimeout(setupEventLogWhenReady, 500);
        }
    };
    
    setupEventLogWhenReady();
}
</script>
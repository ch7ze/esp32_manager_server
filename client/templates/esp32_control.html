<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Device Control</title>
    <link rel="stylesheet" href="/stylesheets/styles.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* ESP32-specific styling */
        .esp32-device-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 20px;
            min-height: 500px;
        }
        
        .esp32-device-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .connection-status {
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .status-connected { background-color: #28a745; }
        .status-connecting { background-color: #ffc107; animation: pulse 2s infinite; }
        .status-disconnected { background-color: #dc3545; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        
        .monitor-area {
            background-color: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            height: 200px;
            overflow-y: auto;
            border: 1px solid #444;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        
        .variable-control {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .variable-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }
        
        .variable-name {
            min-width: 120px;
            font-weight: 500;
            color: #495057;
        }
        
        .variable-value {
            flex: 1;
            max-width: 100px;
        }
        
        .start-options-area {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        /* Responsive layout */
        @media (max-width: 768px) {
            .esp32-tabs {
                display: none !important;
            }
            .esp32-stack {
                display: block !important;
            }
        }
        
        @media (min-width: 769px) {
            .esp32-tabs {
                display: block !important;
            }
            .esp32-stack {
                display: none !important;
            }
        }
        
        @media (min-width: 1400px) {
            .esp32-grid {
                display: grid !important;
                grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
                gap: 20px;
            }
            .esp32-tabs,
            .esp32-stack {
                display: none !important;
            }
        }
        
        .user-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .device-users {
            font-size: 0.8em;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-cpu"></i> ESP32 Manager
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Drawing Board</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/esp32_control.html">ESP32 Control</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i> <span id="user-display-name">User</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/profile.html">Profile</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()">Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <!-- Loading State -->
        <div id="loading-state" class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading ESP32 devices...</span>
            </div>
            <p class="mt-2">Connecting to ESP32 devices...</p>
        </div>

        <!-- No Devices State -->
        <div id="no-devices-state" class="text-center" style="display: none;">
            <div class="alert alert-info">
                <h4><i class="bi bi-info-circle"></i> No ESP32 devices available</h4>
                <p>No ESP32 devices are currently configured or connected.</p>
                <button class="btn btn-primary" onclick="refreshDevices()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>

        <!-- Tab Layout (Desktop) -->
        <div id="esp32-tabs" class="esp32-tabs" style="display: none;">
            <ul class="nav nav-tabs" id="deviceTabs" role="tablist">
                <!-- Dynamic tabs will be inserted here -->
            </ul>
            <div class="tab-content" id="deviceTabContent">
                <!-- Dynamic tab content will be inserted here -->
            </div>
        </div>

        <!-- Stack Layout (Mobile) -->
        <div id="esp32-stack" class="esp32-stack" style="display: none;">
            <!-- Dynamic stacked devices will be inserted here -->
        </div>

        <!-- Grid Layout (Large screens) -->
        <div id="esp32-grid" class="esp32-grid" style="display: none;">
            <!-- Dynamic grid devices will be inserted here -->
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/scripts/auth-utils.js"></script>
    <script>
        // Global state
        let websocket = null;
        let esp32Devices = new Map();
        let currentUser = null;
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeAuth();
            await initializeWebSocket();
        });
        
        async function initializeAuth() {
            try {
                const response = await fetch('/api/user-info', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    currentUser = await response.json();
                    document.getElementById('user-display-name').textContent = currentUser.display_name;
                } else {
                    window.location.href = '/login.html';
                }
            } catch (error) {
                console.error('Auth initialization failed:', error);
                window.location.href = '/login.html';
            }
        }
        
        async function initializeWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/channel`;
            
            try {
                websocket = new WebSocket(wsUrl);
                
                websocket.onopen = function() {
                    console.log('WebSocket connected');
                    // Request list of ESP32 devices
                    requestDeviceList();
                };
                
                websocket.onmessage = function(event) {
                    handleWebSocketMessage(JSON.parse(event.data));
                };
                
                websocket.onclose = function() {
                    console.log('WebSocket disconnected');
                    setTimeout(initializeWebSocket, 3000); // Reconnect after 3s
                };
                
                websocket.onerror = function(error) {
                    console.error('WebSocket error:', error);
                };
                
            } catch (error) {
                console.error('WebSocket initialization failed:', error);
                document.getElementById('loading-state').innerHTML = `
                    <div class="alert alert-danger">
                        <h4>Connection Failed</h4>
                        <p>Could not connect to ESP32 service.</p>
                        <button class="btn btn-primary" onclick="initializeWebSocket()">Retry</button>
                    </div>
                `;
            }
        }
        
        function requestDeviceList() {
            // This would be extended to request available ESP32 devices
            // For now, we register for the test device
            registerForDevice('test-esp32-001');
        }
        
        function registerForDevice(deviceId) {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({
                    command: 'registerForDevice',
                    deviceId: deviceId
                }));
            }
        }
        
        function handleWebSocketMessage(message) {
            if (message.deviceId && message.eventsForDevice) {
                handleDeviceEvents(message.deviceId, message.eventsForDevice);
            }
        }
        
        function handleDeviceEvents(deviceId, events) {
            // Ensure device exists in our UI
            if (!esp32Devices.has(deviceId)) {
                createDeviceUI(deviceId);
            }
            
            events.forEach(event => {
                processDeviceEvent(deviceId, event);
            });
        }
        
        function createDeviceUI(deviceId) {
            const device = {
                id: deviceId,
                name: deviceId.replace('test-', '').replace('-', ' ').toUpperCase(),
                connected: false,
                users: [],
                udpMessages: [],
                tcpMessages: [],
                variables: new Map(),
                startOptions: []
            };
            
            esp32Devices.set(deviceId, device);
            renderDevices();
        }
        
        function processDeviceEvent(deviceId, event) {
            const device = esp32Devices.get(deviceId);
            if (!device) return;
            
            switch (event.event) {
                case 'esp32ConnectionStatus':
                    device.connected = event.connected;
                    updateConnectionStatus(deviceId, event.connected);
                    break;
                    
                case 'esp32UdpBroadcast':
                    device.udpMessages.push(`[${new Date().toLocaleTimeString()}] ${event.message}`);
                    updateMonitorArea(deviceId, 'udp');
                    break;
                    
                case 'esp32VariableUpdate':
                    device.variables.set(event.variableName, event.variableValue);
                    updateVariableMonitor(deviceId, event.variableName, event.variableValue);
                    break;
                    
                case 'esp32StartOptions':
                    device.startOptions = event.options;
                    updateStartOptions(deviceId, event.options);
                    break;
                    
                case 'esp32ChangeableVariables':
                    updateVariableControls(deviceId, event.variables);
                    break;
                    
                case 'userJoined':
                    if (event.userId !== 'ESP32_SYSTEM') {
                        device.users.push({
                            userId: event.userId,
                            displayName: event.displayName,
                            userColor: event.userColor
                        });
                        updateDeviceUsers(deviceId);
                    }
                    break;
                    
                case 'userLeft':
                    if (event.userId !== 'ESP32_SYSTEM') {
                        device.users = device.users.filter(u => u.userId !== event.userId);
                        updateDeviceUsers(deviceId);
                    }
                    break;
                    
                default:
                    console.log('Unknown ESP32 event:', event);
            }
        }
        
        function renderDevices() {
            if (esp32Devices.size === 0) {
                showNoDevicesState();
                return;
            }
            
            hideLoadingState();
            
            // Clear existing content
            document.getElementById('deviceTabs').innerHTML = '';
            document.getElementById('deviceTabContent').innerHTML = '';
            document.getElementById('esp32-stack').innerHTML = '';
            document.getElementById('esp32-grid').innerHTML = '';
            
            const devices = Array.from(esp32Devices.values());
            
            devices.forEach((device, index) => {
                createDeviceTabContent(device, index === 0);
                createDeviceStackContent(device);
                createDeviceGridContent(device);
            });
            
            showDevicesContainer();
        }
        
        function createDeviceTabContent(device, isActive) {
            // Create tab
            const tab = document.createElement('li');
            tab.className = 'nav-item';
            tab.innerHTML = `
                <button class="nav-link ${isActive ? 'active' : ''}" 
                        id="${device.id}-tab" 
                        data-bs-toggle="tab" 
                        data-bs-target="#${device.id}-content" 
                        type="button" 
                        role="tab">
                    <span class="status-dot ${getStatusClass(device.connected)}"></span>
                    ${device.name}
                </button>
            `;
            document.getElementById('deviceTabs').appendChild(tab);
            
            // Create tab content
            const content = document.createElement('div');
            content.className = `tab-pane fade ${isActive ? 'show active' : ''}`;
            content.id = `${device.id}-content`;
            content.setAttribute('role', 'tabpanel');
            content.innerHTML = createDeviceContent(device);
            document.getElementById('deviceTabContent').appendChild(content);
        }
        
        function createDeviceStackContent(device) {
            const stackItem = document.createElement('div');
            stackItem.className = 'esp32-device-card mb-4';
            stackItem.innerHTML = `
                <div class="esp32-device-header">
                    <div>
                        <h5 class="mb-1">${device.name}</h5>
                        <div class="connection-status">
                            <span class="status-dot ${getStatusClass(device.connected)}"></span>
                            ${getStatusText(device.connected)}
                        </div>
                    </div>
                    <div class="device-users" id="${device.id}-stack-users"></div>
                </div>
                <div class="p-3">
                    ${createDeviceContent(device)}
                </div>
            `;
            document.getElementById('esp32-stack').appendChild(stackItem);
        }
        
        function createDeviceGridContent(device) {
            const gridItem = document.createElement('div');
            gridItem.className = 'esp32-device-card';
            gridItem.innerHTML = `
                <div class="esp32-device-header">
                    <div>
                        <h5 class="mb-1">${device.name}</h5>
                        <div class="connection-status">
                            <span class="status-dot ${getStatusClass(device.connected)}"></span>
                            ${getStatusText(device.connected)}
                        </div>
                    </div>
                    <div class="device-users" id="${device.id}-grid-users"></div>
                </div>
                <div class="p-3">
                    ${createDeviceContent(device)}
                </div>
            `;
            document.getElementById('esp32-grid').appendChild(gridItem);
        }
        
        function createDeviceContent(device) {
            return `
                <!-- Control Panel -->
                <div class="start-options-area">
                    <h6><i class="bi bi-play-circle"></i> Device Control</h6>
                    <div class="row align-items-end">
                        <div class="col-md-4">
                            <label class="form-label">Start Option</label>
                            <select class="form-select" id="${device.id}-start-select">
                                <option value="">Select option...</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="${device.id}-auto-start">
                                <label class="form-check-label" for="${device.id}-auto-start">Auto Start</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-success me-2" onclick="sendStartOption('${device.id}')">
                                <i class="bi bi-play"></i> Start
                            </button>
                            <button class="btn btn-danger" onclick="sendReset('${device.id}')">
                                <i class="bi bi-arrow-clockwise"></i> Reset
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Variable Controls -->
                <div class="variable-control">
                    <h6><i class="bi bi-sliders"></i> Variable Control</h6>
                    <div id="${device.id}-variables">
                        <p class="text-muted">No variables available</p>
                    </div>
                </div>
                
                <!-- Monitors -->
                <div class="row">
                    <div class="col-lg-6">
                        <h6><i class="bi bi-broadcast"></i> UDP Monitor</h6>
                        <div class="monitor-area" id="${device.id}-udp-monitor"></div>
                    </div>
                    <div class="col-lg-6">
                        <h6><i class="bi bi-link-45deg"></i> Variable Monitor</h6>
                        <div class="monitor-area" id="${device.id}-variable-monitor"></div>
                    </div>
                </div>
            `;
        }
        
        function getStatusClass(connected) {
            return connected ? 'status-connected' : 'status-disconnected';
        }
        
        function getStatusText(connected) {
            return connected ? 'Connected' : 'Disconnected';
        }
        
        function hideLoadingState() {
            document.getElementById('loading-state').style.display = 'none';
        }
        
        function showNoDevicesState() {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('no-devices-state').style.display = 'block';
        }
        
        function showDevicesContainer() {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('no-devices-state').style.display = 'none';
            
            // Show appropriate layout based on screen size
            if (window.innerWidth >= 1400) {
                document.getElementById('esp32-grid').style.display = 'grid';
            } else if (window.innerWidth >= 769) {
                document.getElementById('esp32-tabs').style.display = 'block';
            } else {
                document.getElementById('esp32-stack').style.display = 'block';
            }
        }
        
        function updateConnectionStatus(deviceId, connected) {
            // Update all status indicators for this device
            const statusElements = document.querySelectorAll(`[id*="${deviceId}"] .status-dot`);
            statusElements.forEach(el => {
                el.className = `status-dot ${getStatusClass(connected)}`;
            });
        }
        
        function updateMonitorArea(deviceId, type) {
            const device = esp32Devices.get(deviceId);
            const monitorEl = document.getElementById(`${deviceId}-udp-monitor`);
            if (monitorEl && type === 'udp') {
                monitorEl.innerHTML = device.udpMessages.slice(-50).join('<br>');
                monitorEl.scrollTop = monitorEl.scrollHeight;
            }
        }
        
        function updateVariableMonitor(deviceId, name, value) {
            const monitorEl = document.getElementById(`${deviceId}-variable-monitor`);
            if (monitorEl) {
                const timestamp = new Date().toLocaleTimeString();
                const existingContent = monitorEl.innerHTML;
                monitorEl.innerHTML = existingContent + `<br>[${timestamp}] ${name}: ${value}`;
                monitorEl.scrollTop = monitorEl.scrollHeight;
            }
        }
        
        function updateStartOptions(deviceId, options) {
            const selectEl = document.getElementById(`${deviceId}-start-select`);
            if (selectEl) {
                selectEl.innerHTML = '<option value="">Select option...</option>';
                options.forEach(option => {
                    const optionEl = document.createElement('option');
                    optionEl.value = option;
                    optionEl.textContent = option;
                    selectEl.appendChild(optionEl);
                });
            }
        }
        
        function updateVariableControls(deviceId, variables) {
            const containerEl = document.getElementById(`${deviceId}-variables`);
            if (containerEl) {
                if (variables.length === 0) {
                    containerEl.innerHTML = '<p class="text-muted">No variables available</p>';
                    return;
                }
                
                containerEl.innerHTML = '';
                variables.forEach(variable => {
                    const variableEl = document.createElement('div');
                    variableEl.className = 'variable-item';
                    variableEl.innerHTML = `
                        <div class="variable-name">${variable.name}</div>
                        <input type="number" 
                               class="form-control variable-value" 
                               value="${variable.value}"
                               min="0"
                               onkeypress="handleVariableKeyPress(event, '${deviceId}', '${variable.name}')">
                        <button class="btn btn-sm btn-outline-primary" 
                                onclick="sendVariable('${deviceId}', '${variable.name}')">
                            <i class="bi bi-send"></i>
                        </button>
                    `;
                    containerEl.appendChild(variableEl);
                });
            }
        }
        
        function updateDeviceUsers(deviceId) {
            const device = esp32Devices.get(deviceId);
            ['tabs', 'stack', 'grid'].forEach(layout => {
                const usersEl = document.getElementById(`${deviceId}-${layout}-users`);
                if (usersEl) {
                    if (device.users.length === 0) {
                        usersEl.innerHTML = '';
                    } else {
                        usersEl.innerHTML = device.users.map(user => `
                            <span class="user-indicator" style="background-color: ${user.userColor}"></span>
                            ${user.displayName}
                        `).join(', ');
                    }
                }
            });
        }
        
        // Event handlers
        function sendStartOption(deviceId) {
            const selectEl = document.getElementById(`${deviceId}-start-select`);
            if (selectEl && selectEl.value && websocket) {
                websocket.send(JSON.stringify({
                    command: 'deviceEvent',
                    deviceId: deviceId,
                    eventsForDevice: [{
                        event: 'esp32Command',
                        command: {
                            startOption: selectEl.value
                        }
                    }]
                }));
            }
        }
        
        function sendReset(deviceId) {
            if (websocket) {
                websocket.send(JSON.stringify({
                    command: 'deviceEvent',
                    deviceId: deviceId,
                    eventsForDevice: [{
                        event: 'esp32Command',
                        command: {
                            reset: true
                        }
                    }]
                }));
            }
        }
        
        function sendVariable(deviceId, variableName) {
            const inputEl = document.querySelector(`#${deviceId}-variables input[onkeypress*="${variableName}"]`);
            if (inputEl && websocket) {
                const value = parseInt(inputEl.value) || 0;
                websocket.send(JSON.stringify({
                    command: 'deviceEvent',
                    deviceId: deviceId,
                    eventsForDevice: [{
                        event: 'esp32Command',
                        command: {
                            setVariable: {
                                name: variableName,
                                value: value
                            }
                        }
                    }]
                }));
            }
        }
        
        function handleVariableKeyPress(event, deviceId, variableName) {
            if (event.key === 'Enter') {
                sendVariable(deviceId, variableName);
            }
        }
        
        function refreshDevices() {
            location.reload();
        }
        
        function logout() {
            fetch('/api/logout', { method: 'POST', credentials: 'include' })
                .then(() => window.location.href = '/login.html')
                .catch(() => window.location.href = '/login.html');
        }
        
        // Handle window resize for responsive layout
        window.addEventListener('resize', function() {
            if (esp32Devices.size > 0) {
                showDevicesContainer();
            }
        });
    </script>
</body>
</html>
<div class="page-content">
    <nav class="auth-nav">
        <a href="index.html" class="spa-link home-link">‚Üê Back to Home</a>
        <a href="debug.html" class="spa-link">Debug</a>
    </nav>
    
    <div class="admin-container">
        <h1>Administrator Area</h1>
        <p>Here you can manage and view the user database.</p>
        
        <div id="admin-message" class="auth-message" style="display: none;"></div>
        
        <div class="admin-section">
            <h2>Database Overview</h2>
            <div class="stats-container">
                <div class="stat-box">
                    <span class="stat-number" id="total-users">-</span>
                    <span class="stat-label">Benutzer gesamt</span>
                </div>
                <div class="stat-box">
                    <span class="stat-number" id="admin-users">-</span>
                    <span class="stat-label">Administratoren</span>
                </div>
            </div>
        </div>
        
        <div class="admin-section">
            <h2>User Management</h2>
            <div class="user-controls">
                <button id="refresh-users" class="admin-button">Refresh</button>
                <input type="text" id="user-search" placeholder="Nach Benutzer suchen..." class="search-input">
            </div>
            
            <div class="users-table-container">
                <table id="users-table" class="users-table">
                    <thead>
                        <tr>
                            <th>Anzeigename</th>
                            <th>Admin</th>
                            <th>Erstellt</th>
                            <th>Aktionen</th>
                        </tr>
                    </thead>
                    <tbody id="users-tbody">
                        <tr>
                            <td colspan="5" class="loading">Lade Benutzerdaten...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
.admin-container {
    max-width: 1200px;
    margin: 20px auto;
    padding: 30px;
}

.admin-section {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 30px;
}

.admin-section h2 {
    margin-top: 0;
    color: #495057;
    border-bottom: 2px solid #007bff;
    padding-bottom: 10px;
}

.stats-container {
    display: flex;
    gap: 20px;
    margin-top: 20px;
}

.stat-box {
    flex: 1;
    background-color: white;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stat-number {
    display: block;
    font-size: 2em;
    font-weight: bold;
    color: #007bff;
    margin-bottom: 5px;
}

.stat-label {
    color: #6c757d;
    font-size: 0.9em;
}

.user-controls {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    align-items: center;
}

.admin-button {
    padding: 10px 20px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.admin-button:hover {
    background-color: #0056b3;
}

.admin-button:disabled {
    background-color: #6c757d;
    cursor: not-allowed;
}

.admin-button.danger {
    background-color: #dc3545;
}

.admin-button.danger:hover {
    background-color: #c82333;
}

.admin-button.warning {
    background-color: #ffc107;
    color: #212529;
}

.admin-button.warning:hover {
    background-color: #e0a800;
}

.search-input {
    padding: 10px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
    flex: 1;
    max-width: 300px;
}

.users-table-container {
    background-color: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.users-table {
    width: 100%;
    border-collapse: collapse;
}

.users-table th,
.users-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #dee2e6;
}

.users-table th {
    background-color: #e9ecef;
    font-weight: bold;
    color: #495057;
}

.users-table tbody tr:hover {
    background-color: #f8f9fa;
}

.users-table .loading {
    text-align: center;
    color: #6c757d;
    font-style: italic;
}

.admin-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
    text-align: center;
    min-width: 50px;
}

.admin-badge.yes {
    background-color: #d4edda;
    color: #155724;
}

.admin-badge.no {
    background-color: #f8d7da;
    color: #721c24;
}

.user-actions {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
}

.user-actions .admin-button {
    padding: 5px 10px;
    font-size: 12px;
}

.date-display {
    font-size: 12px;
    color: #6c757d;
}

/* Auth message styles from login.html */
.auth-message {
    margin: 15px 0;
    padding: 10px;
    border-radius: 4px;
    text-align: center;
}

.auth-message.success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.auth-message.error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.auth-nav {
    margin-bottom: 20px;
    padding: 10px 0;
    border-bottom: 1px solid #e9ecef;
}

.auth-nav a {
    display: inline-block;
    margin-right: 15px;
    color: #007bff;
    text-decoration: none;
    padding: 5px 10px;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.auth-nav a:hover {
    background-color: #e9ecef;
    text-decoration: none;
}

.auth-nav .home-link {
    font-weight: bold;
}

@media (max-width: 768px) {
    .admin-container {
        padding: 15px;
    }
    
    .stats-container {
        flex-direction: column;
    }
    
    .user-controls {
        flex-direction: column;
        align-items: stretch;
    }
    
    .search-input {
        max-width: none;
    }
    
    .users-table-container {
        overflow-x: auto;
    }
    
    .users-table {
        min-width: 600px;
    }
}
</style>

<script>
// Use setTimeout to ensure DOM elements are available after template injection
setTimeout(function() {
    const messageDiv = document.getElementById('admin-message');
    const refreshButton = document.getElementById('refresh-users');
    const searchInput = document.getElementById('user-search');
    const usersTable = document.getElementById('users-table');
    const usersTbody = document.getElementById('users-tbody');
    const totalUsersSpan = document.getElementById('total-users');
    const adminUsersSpan = document.getElementById('admin-users');
    
    let allUsers = [];
    let filteredUsers = [];
    
    // Check if user has admin privileges
    async function checkAdminAccess() {
        try {
            const response = await fetch('/api/user-info', {
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error('Nicht eingeloggt');
            }
            
            const data = await response.json();
            
            // Check if user is admin (from database)
            const adminCheckResponse = await fetch('/api/admin/users', {
                credentials: 'include'
            });
            
            if (adminCheckResponse.status === 403) {
                showMessage('You do not have administrator privileges.', 'error');
                return false;
            } else if (!adminCheckResponse.ok) {
                throw new Error('Admin access could not be verified');
            }
            
            return true;
        } catch (error) {
            showMessage('Error checking authorization: ' + error.message, 'error');
            return false;
        }
    }
    
    // Load users from admin API
    async function loadUsers() {
        if (!(await checkAdminAccess())) {
            return;
        }
        
        refreshButton.disabled = true;
        refreshButton.textContent = 'Loading...';
        
        try {
            const response = await fetch('/api/admin/users', {
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                allUsers = data.users;
                filteredUsers = [...allUsers];
                updateStats();
                renderUsers();
                showMessage('User data loaded successfully.', 'success');
                setTimeout(() => hideMessage(), 3000);
            } else {
                throw new Error(data.message || 'Unbekannter Fehler');
            }
        } catch (error) {
            showMessage('Error loading users: ' + error.message, 'error');
            usersTbody.innerHTML = '<tr><td colspan="5" class="loading">Fehler beim Laden der Daten</td></tr>';
        } finally {
            refreshButton.disabled = false;
            refreshButton.textContent = 'Refresh';
        }
    }
    
    // Update statistics
    function updateStats() {
        const totalUsers = allUsers.length;
        const adminUsers = allUsers.filter(user => user.is_admin).length;
        
        totalUsersSpan.textContent = totalUsers;
        adminUsersSpan.textContent = adminUsers;
    }
    
    // Render users table
    function renderUsers() {
        if (filteredUsers.length === 0) {
            usersTbody.innerHTML = '<tr><td colspan="5" class="loading">Keine Benutzer gefunden</td></tr>';
            return;
        }
        
        const html = filteredUsers.map(user => {
            const createdDate = new Date(user.created_at).toLocaleString('de-DE');
            const adminBadge = user.is_admin ? 
                '<span class="admin-badge yes">Ja</span>' : 
                '<span class="admin-badge no">Nein</span>';
            
            return `
                <tr data-user-id="${user.id}">
                    <td><strong>${escapeHtml(user.display_name)}</strong></td>
                    <td>${adminBadge}</td>
                    <td><span class="date-display">${createdDate}</span></td>
                    <td>
                        <div class="user-actions">
                            <button class="admin-button warning" onclick="toggleAdmin('${user.id}', ${!user.is_admin})">
                                ${user.is_admin ? 'Remove Admin' : 'Make Admin'}
                            </button>
                            <button class="admin-button danger" onclick="deleteUser('${user.id}', '${escapeHtml(user.display_name)}')">
                                Delete
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        
        usersTbody.innerHTML = html;
    }
    
    // Filter users based on search
    function filterUsers() {
        const query = searchInput.value.toLowerCase().trim();
        
        if (query === '') {
            filteredUsers = [...allUsers];
        } else {
            filteredUsers = allUsers.filter(user => 
                user.display_name.toLowerCase().includes(query)
            );
        }
        
        renderUsers();
    }
    
    // Delete user
    window.deleteUser = async function(userId, userName) {
        if (!confirm(`Do you really want to delete the user "${userName}"? This action cannot be undone.`)) {
            return;
        }
        
        try {
            const response = await fetch(`/api/admin/users/${userId}`, {
                method: 'POST',
                credentials: 'include'
            });
            
            const data = await response.json();
            
            if (data.success) {
                showMessage(`User "${userName}" was successfully deleted.`, 'success');
                loadUsers(); // Reload user list
            } else {
                throw new Error(data.message || 'Unbekannter Fehler');
            }
        } catch (error) {
            showMessage('Error deleting user: ' + error.message, 'error');
        }
    };
    
    // Toggle admin status
    window.toggleAdmin = async function(userId, makeAdmin) {
        const action = makeAdmin ? 'Admin-Rechte verleihen' : 'Admin-Rechte entziehen';
        
        if (!confirm(`Do you really want to ${action} this user?`)) {
            return;
        }
        
        try {
            const response = await fetch(`/api/admin/users/${userId}/admin`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ is_admin: makeAdmin }),
                credentials: 'include'
            });
            
            const data = await response.json();
            
            if (data.success) {
                showMessage(`${data.message}`, 'success');
                loadUsers(); // Reload user list
            } else {
                throw new Error(data.message || 'Unbekannter Fehler');
            }
        } catch (error) {
            showMessage('Error changing admin status: ' + error.message, 'error');
        }
    };
    
    // Helper functions
    function showMessage(message, type) {
        messageDiv.textContent = message;
        messageDiv.className = `auth-message ${type}`;
        messageDiv.style.display = 'block';
    }
    
    function hideMessage() {
        messageDiv.style.display = 'none';
    }
    
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }
    
    // Event listeners
    if (refreshButton) {
        refreshButton.addEventListener('click', loadUsers);
    }
    
    if (searchInput) {
        searchInput.addEventListener('input', filterUsers);
        searchInput.addEventListener('keyup', filterUsers);
    }
    
    // Initial load
    loadUsers();
    
}, 100); // Wait 100ms for DOM to be ready
</script>